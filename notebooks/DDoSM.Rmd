---
title: "DDoS Attack Mitigation"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*. When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file). The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
library(dplyr)
library(ggplot2)
library(readr)
```

Load the dataset.

```{r}
packets <- read_csv("~/p4sec/ddosm-p4/pcaps/ddos20m14/if3_attack_out.csv", col_types = cols(
  src = col_character(),
  dst = col_character(),
  id = col_character(),
  attack = col_logical()
))
```

Add a column with the index of the packet.

```{r}
packets = packets %>% tibble::rowid_to_column("index")
```

Add a column with the number of the observation window.

```{r}
log2m = 14
m = 2^log2m
get_ow = function(index, m) ((index - 1) %/% m + 1)
packets = packets %>% mutate(ow = get_ow(index,m)) 
packets = packets %>% rename(delta = id)
```

Convert the ip.id field from hexadecimal to decimal. 

```{r}
#packets %>% slice((767 * 2^14 + 1):(769 * 2^14)) %>% mutate(id=strtoi(id))
packets = packets %>% mutate(delta=strtoi(delta))
```


Note: check the DDoS Mitigation notebook, where I calculate the indices. 

```{r}
packets %>% filter(index >= 4194300) 
```

As we can see, the attack begins with the fifth packet of OW 257. 

Get stats for the second OW under attack: histogram of addresses for each delta value. 

```{r}
query = packets %>% filter(ow >= 257, ow <= 512) %>% group_by(ow, attack, delta) %>% summarize(sources=n_distinct(src)) 
query %>% ggplot(mapping=aes(x=delta, y=sources, color=attack)) + geom_line() # + coord_cartesian(xlim=c(0,1500),ylim=c(0,4000))
```



```{r}
query %>% filter(attack==FALSE) %>% ggplot(mapping=aes(x=delta, y=sources, color=attack)) + geom_point() + coord_cartesian(xlim=c(0,1500),ylim=c(0,4000))
```

```{r}
query %>% filter(attack==TRUE) %>% ggplot(mapping=aes(x=delta, y=sources, color=attack)) + geom_point() + coord_cartesian(xlim=c(0,1500),ylim=c(0,4000))
```

To analyze the behavior of our classifier, it would be interesting to plot a histogram using 16 (2^log2(m-10)) as a bin size.

Let's set an arbitrary threshold.

```{r}
threshold = 16
first = 257
last = 288

query = packets %>% filter(ow>=first, ow<=last)

true_evil = query %>% filter(attack==TRUE) %>% tally()
true_good = query %>% filter(attack==FALSE) %>% tally()
message("True evil: ", true_evil, " True good: ", true_good, " Total: ", true_evil + true_good)

class_evil = query %>% filter(delta>=threshold) %>% tally() 
class_good = query %>% filter(delta< threshold) %>% tally() 
message("Class evil: ", class_evil, " Class good: ", class_good, " Total: ", class_evil + class_good)

error_evil = query %>% filter(delta< threshold, attack==TRUE)  %>% tally() 
error_good = query %>% filter(delta>=threshold, attack==FALSE) %>% tally() 
message("Error evil: ", error_evil, " Error good: ", error_good, " Total: ", error_evil + error_good)
message("Error evil: ", error_evil/true_evil, " Error good: ", error_good/true_good)


```

With a threshold equal to 16, we divert ~83% of the attack, while keeping >90% of the good traffic in the original path. 

