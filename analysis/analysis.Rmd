---
title: "DDoS Attack Mitigation"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---
```{r setup, echo=FALSE, include=FALSE}

source("analysis.R")

knitr::opts_chunk$set(tidy=TRUE, tidy.opts=list(width.cutoff=160))

```

# Overview

## Parameters

We used a packet trace with approximately n=2^27 (exactly n=2^17*1000) packets in the detection phase.

```{r parameters}

log2n = as.integer(27)

```

## Packet Traces 

```{r loading}

pcap_dir = "~/p4sec/ddosm-p4/pcaps"

pcap_csv_m14 = str_c(pcap_dir,"/n_2_27_m_2_14/if3_attack_out.csv.gz")
pcap_csv_m16 = str_c(pcap_dir,"/n_2_27_m_2_16/if3_attack_out.csv.gz")
pcap_csv_m18 = str_c(pcap_dir,"/n_2_27_m_2_18/if3_attack_out.csv.gz")

#packets_m14 = read_pcap_csv(log2n=log2n, log2m=14, pcap_csv=pcap_csv_m14, attack_only=TRUE) 
#packets_m16 = read_pcap_csv(log2n=log2n, log2m=16, pcap_csv=pcap_csv_m16, attack_only=TRUE) 
#packets_m18 = read_pcap_csv(log2n=log2n, log2m=18, pcap_csv=pcap_csv_m18, attack_only=TRUE) 


```

## TCAD Traces

Sensitivity Coefficients 

Our experiments with tcad_m_levels.py show us candidate values for k, as follows: 

Log2(m) | k     | FPR
--------|-------|-----
14      | 4.125 | 1.7%
16      | 4.500 | 1.6%
18      | 3.625 | 0.0%

[Source: DDoS Mitigation.ipynb, section Finding TCAD Values]

```{r }

# tcad.trace.dir = "~/p4sec/ddosm-p4/labs/ddos20_long/tcad_logs"
tcad.trace.dir = "D:/P4/ddosm-p4/labs/ddos20_long/tcad_logs"

tcad.m14.k = 4.875
tcad.m16.k = 4.875
tcad.m18.k = 3.625

tcad.m14.trace = str_c(tcad.trace.dir,"/tcad_m_2_14_k_4.875.log")
tcad.m16.trace = str_c(tcad.trace.dir,"/tcad_m_2_16_k_4.875.log")
tcad.m18.trace = str_c(tcad.trace.dir,"/tcad_m_2_18_k_3.625.log")

tcad.m14 = read_tcad_trace(tcad.m14.trace)
tcad.m16 = read_tcad_trace(tcad.m16.trace)
tcad.m18 = read_tcad_trace(tcad.m18.trace)


```

# Workload Characterization

## Entropy Overview

```{r entropy_overview, include=TRUE}

entropy.title = "Entropy for each Observation Window "

get_plot_tcad(tcad.m14, tcad.m14.k) + labs(title=str_c(entropy.title,"(m = 2^14)"))
my_ggsave(plot=last_plot(), path="graphics_m14", filename="entropy_all_n_2_27")

get_plot_tcad(tcad.m16, tcad.m16.k) + labs(title=str_c(entropy.title,"(m = 2^16)"))
my_ggsave(plot=last_plot(), path="graphics_m16", filename="entropy_all_n_2_27")

get_plot_tcad(tcad.m18, tcad.m18.k) + labs(title=str_c(entropy.title,"(m = 2^18)"))
my_ggsave(plot=last_plot(), path="graphics_m18", filename="entropy_all_n_2_27")

```

## Entropy Under Attack

We have the graph for the entire experiments. Now we need to focus in the attack.

```{r entropy_under_attack, include=TRUE}

title = "Entropy for each Observation Window - Attack Phase "

get_plot_tcad_attack(tcad.m14, tcad.m14.k, log2n, 14) + labs(title=str_c(title,"(m = 2^14)"))
my_ggsave(plot=last_plot(), path="graphics_m14", filename="entropy_attack_n_2_27")

get_plot_tcad_attack(tcad.m16, tcad.m16.k, log2n, 16) + labs(title=str_c(title,"(m = 2^16)"))
my_ggsave(plot=last_plot(), path="graphics_m16", filename="entropy_attack_n_2_27")

get_plot_tcad_attack(tcad.m18, tcad.m18.k, log2n, 18) + labs(title=str_c(title,"(m = 2^18)"))
my_ggsave(plot=last_plot(), path="graphics_m18", filename="entropy_attack_n_2_27")

```

# Attack Mitigation

## Typical Deltas

For each OW, what are the typical frequency deltas for attack packets? 

```{r typical_deltas}

for(log2m in seq(14, 18, by=2)) {

  log2m = as.integer(log2m)
  
  if (log2m == 14)  {
    packets = packets_m14 
  } else if (log2m == 16) {
    packets = packets_m16 
  } else if (log2m == 18) {
    packets = packets_m18 
  } else {
    stop("Invalid log2m value.")
  }
  
  deltas = summarize_deltas(log2n, log2m, packets)

  graph_path = str_c("graphics_m", log2m)
  m_annotation = str_c("(m = 2^", log2m, ")") 
  dot_size = 2.0

  delta_plot_options = list(
#    geom_point(aes(y=diffq1), color="blue4", size=dot_size),
    geom_point(aes(y=diffq2), color="blue4", size=dot_size),
#    geom_point(aes(y=diffq3), color="orangered4", size=dot_size),
    labs(x="Observation Window", y="Median Address Frequency Variation", title = str_c("Median Address Frequency Variations ", m_annotation)),
    theme_classic())
  
  deltas %>% ggplot(aes(x=ow, shape=attack)) + delta_plot_options
  
  my_ggsave(plot=last_plot(), path=graph_path, filename="diffs")  
  
}


```

## Diversion Thresholds

We want to find the best value for t, considering its effect on the accuracy of the mechanism. 

Base Stats and Confidence Intervals: TPR and FPR are proportions whose values we need to estimate. Let X be a random variable whose value is 1 when a classification succeeds, and 0 otherwise. Consequently, X follows a a Bernoulli distribution with probability p. We can use our sample to estimate the mean value of p. This sample mean has a sampling error approximately equal to sqrt(p * (1-p) / n), where n is the sample size. Considering the attack as a whole, what is the 95% confidence interval for the mean TPR and FPR?       

```{r best_threshold, include=TRUE}

summary_all = tibble() 

for(log2m in seq(14, 16, by=2)) { # Was 14, 18, 2

  log2m = as.integer(log2m)
  
  if (log2m == 14)  {
    packets = packets_m14 
    sequence = seq(-256, 256, by=16)
  } else if (log2m == 16) {
    packets = packets_m16 
    sequence = seq(-512, 512, by=32)
  } else if (log2m == 18) {
    packets = packets_m18 
    sequence = seq(-1024, 1024, by=64)
  } else {
    stop("Invalid log2m value.")
  }

  for(diff_threshold in sequence) { # Old: -640, 640, 32; OK: -32, 384, by=32
  
    divert = function(diff) (diff >= diff_threshold)
    packets = packets %>% 
      mutate(diverted=divert(diff)) %>% 
      mutate(tp =  attack & diverted, fp = !attack & diverted) %>%
      ungroup() # %>% group_by(ow)
    stats = get_stats(packets)
    summary = get_summary(stats, log2n, log2m, diff_threshold)
    summary_all = bind_rows(summary_all, summary)
    
  }
  

}

summary_all

# summary_all = read.csv('summary_all.csv')

# Log2m == 14: ideal = 512
# Log2m == 16: ideal = 768
# Log2m == 18: ideal = 1280

summary_all %>% 
  ggplot(aes(x=t/2^(log2m/2+1), color=as.factor(log2m))) + 
  geom_line(aes(y=p_tp)) + geom_point(aes(y=p_tp), shape=5) + 
  geom_line(aes(y=p_fp)) + geom_point(aes(y=p_fp), shape=4) + 
  scale_color_manual(name="log2m", breaks=c(14,16,18), values=c("red","green","blue")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x="Normalized Mitigation Threshold (t/2^(log2(m)/2+1))", y="") + 
  theme_classic() 

graph_path = "graphics"
my_ggsave(plot=last_plot(), path=graph_path, filename="tpr_fpr")

summary_all_tpr = summary_all %>% transmute(log2m=log2m, t=t, type="TPR", mean=p_tp, lb=i95_tp_lb, ub=i95_tp_ub) 
summary_all_fpr = summary_all %>% transmute(log2m=log2m, t=t, type="FPR", mean=p_fp, lb=i95_fp_lb, ub=i95_fp_ub) 
summary_all_x = bind_rows(summary_all_tpr, summary_all_fpr)

summary_all_x

summary_all_x %>% 
  ggplot(aes(x=t/2^(log2m/2+1), color=type, shape=type)) + 
  geom_line(aes(y=mean), linetype="dashed" ) + 
  geom_point(aes(y=mean), size=2) + 
  geom_errorbar(aes(ymin=lb, ymax=ub)) + 
  scale_color_manual(name="type", values=c("red","blue")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x="Normalized Mitigation Threshold (t/2^(log2(m)/2+1))", y="") + 
  #facet_grid(rows = vars(log2m), labeller = label_both) +
  theme_classic() +
  theme(legend.title = element_blank())


my_ggsave(plot=last_plot(), path=graph_path, filename="tpr_fpr_2")



```

```{r}

summary_all = read.csv('summary_all.csv')
summary_all_tpr = summary_all %>% transmute(log2m=log2m, t=t, type="TPR", mean=p_tp, lb=i95_tp_lb, ub=i95_tp_ub) 
summary_all_fpr = summary_all %>% transmute(log2m=log2m, t=t, type="FPR", mean=p_fp, lb=i95_fp_lb, ub=i95_fp_ub)
summary_all_x = bind_rows(summary_all_tpr, summary_all_fpr)

summary_all_x %>% 
    filter(log2m==14) %>%
    ggplot(aes(x=t/2^(log2m/2+1), color=type, shape=type)) + 
    geom_line(aes(y=mean), linetype="dashed" ) + 
    geom_point(aes(y=mean), size=2) + 
    geom_errorbar(aes(ymin=lb, ymax=ub)) + 
    scale_color_manual(name="type", values=c("red","blue")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs(x="Normalized Mitigation Threshold (t/2^(log2(m)/2+1))", y="") + 
    #facet_grid(rows = vars(log2m), labeller = label_both) +
    theme_classic() +
    theme(legend.title = element_blank(), legend.position = c(0.2,0.2))

graph_path = "graphics"
my_ggsave(plot=last_plot(), path=graph_path, filename="tpr_fpr_m14")

summary_all_x %>% 
    filter(log2m==16) %>%
    ggplot(aes(x=t/2^(log2m/2+1), color=type, shape=type)) + 
    geom_line(aes(y=mean), linetype="dashed" ) + 
    geom_point(aes(y=mean), size=2) + 
    geom_errorbar(aes(ymin=lb, ymax=ub)) + 
    scale_color_manual(name="type", values=c("red","blue")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs(x="Normalized Mitigation Threshold (t/2^(log2(m)/2+1))", y="") + 
    #facet_grid(rows = vars(log2m), labeller = label_both) +
    theme_classic() +
    theme(legend.title = element_blank(), legend.position = c(0.2,0.2))

graph_path = "graphics"
my_ggsave(plot=last_plot(), path=graph_path, filename="tpr_fpr_m16")


summary_all_x %>% 
    filter(log2m==18) %>%
    ggplot(aes(x=t/2^(log2m/2+1), color=type, shape=type)) + 
    geom_line(aes(y=mean), linetype="dashed" ) + 
    geom_point(aes(y=mean), size=2) + 
    geom_errorbar(aes(ymin=lb, ymax=ub)) + 
    scale_color_manual(name="type", values=c("red","blue")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs(x="Normalized Mitigation Threshold (t/2^(log2(m)/2+1))", y="") + 
    #facet_grid(rows = vars(log2m), labeller = label_both) +
    theme_classic() +
    theme(legend.title = element_blank(), legend.position = c(0.2,0.2))

graph_path = "graphics"
my_ggsave(plot=last_plot(), path=graph_path, filename="tpr_fpr_m18")

```


## Diversion Statistics

```{r diversion_stats}

stats_all = tibble()

for(log2m in seq(14, 18, by=2)) {

  log2m = as.integer(log2m)
  
  if (log2m == 14)  {
    packets = packets_m14 
    diff_threshold = 256
  } else if (log2m == 16) {
    packets = packets_m16 
    diff_threshold = 512
  } else if (log2m == 18) {
    packets = packets_m18 
    diff_threshold = 1024
  } else {
    stop("Invalid log2m value.")
  }

  divert = function(diff) (diff >= diff_threshold)
  packets = packets %>% 
    mutate(diverted=divert(diff)) %>%
    mutate(tp =  attack & diverted, fp = !attack & diverted) %>%
    group_by(ow)

  stats = get_stats(packets) %>% mutate(log2n=log2n, log2m=log2m, t=diff_threshold)
  stats_all = bind_rows(stats_all, stats)
    
  graph_path = str_c("graphics_m", log2m)
  m_annotation = str_c("(n = 2^27, m = 2^", log2m, ")")   
  
  # It would be cool to plot several box plots. 
  graph_false_negatives(packets)
  my_ggsave(plot=last_plot(), path=graph_path, filename="false_negatives")
  graph_false_positives(packets)
  my_ggsave(plot=last_plot(), path=graph_path, filename="false_positives")
  graph_results(packets, m_annotation)
  my_ggsave(plot=last_plot(), path=graph_path, filename="results")

}

```

## Address Counts

```{r frequencies}

# graph_options = list(geom_line(), scale_color_manual(values=c("seagreen4", "orangered1")))
# 
# src_distinct = packets %>% group_by(ow, attack, diff) %>% summarize(srcs=n_distinct(src))
# src_distinct %>% ggplot(aes(diff, srcs, color=attack)) + graph_options
# 
# my_ggsave(plot=last_plot(), path=graph_path, filename="src_delta_distribution")
# 
# dst_distinct = packets %>% group_by(ow, attack, diff) %>% summarize(dsts=n_distinct(dst))
# dst_distinct %>% ggplot(aes(diff, dsts, color=attack)) + graph_options
# 
# my_ggsave(plot=last_plot(), path=graph_path, filename="dst_delta_distribution")

```
