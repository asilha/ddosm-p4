---
title: "DDoS Attack Mitigation"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---
```{r setup, echo=FALSE, include=FALSE}

library(dplyr)
library(ggplot2)
library(readr)
knitr::opts_chunk$set(tidy=TRUE, tidy.opts=list(width.cutoff=60))

```


```{r parameters, include=FALSE}

log2m = 14
m = 2^log2m

log2n = 24       # Where n is the total number of packets in the detection phase.  
n = 2^log2n

training_length  = 2^(log2n-log2m-1)   # We need to add this to the OW number when we skip training. 
detection_length = 2^(log2n-log2m)

```

When we preinitialize training coefficients, the length of the workload is equal to the length of the detection phase.

For a detection phase of 2^24 packets we have: 

  2^(24-log2m-2) OWs before the attack,
  2^(24-log2m-1) OWs under attack, 
  2^(24-log2m-2) OWs after the attack.
  
For m=2^14, the detection phase has 2^(24-14)=2^10 windows: 
  
  2^8 OWs before the attack, 
  2^9 OWs under attack, 
  2^8 OWs after the attack. 

For m=2^16: 

  2^6 OWs pre-attack and post-attack,
  2^7 OWs under attack.
  
For m=2^18: 
  
  2^4 OWs pre-attack and post-attack,
  2^5 OWs under attack.

  
```{r functions, include=FALSE}

get_ow = function(index, m) ((index - 1) %/% m + training_length + 1) 

```

# Load the Dataset

```{r dataset, include=FALSE}

col_types = cols(
  src = col_character(),
  dst = col_character(),
  src_delta = col_character(),
  dst_delta = col_character(),
  attack = col_logical())

packets <- read_csv("~/p4sec/ddosm-p4/pcaps/ddos20m14b/if3_attack_out.csv", col_types = col_types)
```

## Add Index Column

```{r}
packets = packets %>% tibble::rowid_to_column("index")
```

## Add OW Number Column

```{r}
packets = packets %>% mutate(ow = get_ow(index,m)) 
```

## Convert Delta Values (Source and Destination)

```{r}

# Convert from hexadecimal to decimal
packets = packets %>% mutate(src_delta=strtoi(src_delta), 
                             dst_delta=strtoi(dst_delta)) 

# Convert from two's complement
packets = packets %>% mutate(src_delta=twos_complement(src_delta), 
                             dst_delta=twos_complement(dst_delta)) 
```

# Attack Overview

At this point we need to check whether we can observe the first attack packet. 

The attack occurs between windows (training_length + detection_length / 4 + 1) and (training_length + detection_length / 2). 

```{r}

attack_start = m * (detection_length / 4 + 1) + 1
attack_start

```

Querying the dataset at the given points.

```{r}

packets %>% filter(index >= attack_start - m)

```

For log2m=14, the attack begins at the fifth packet of OW 769 and lasts for a total of 512 OWs (i.e., OWs 769-1280). 

In OW 769 there is no packet diversion, since we have not set DEFCON yet. In OW 770 DEFCON is already set; the switch begins calculating deltas, using OWs 769 and 768 as a reference. (**Here I can see a potential problem - when we begin moving away from the beginning of the attack, we will have no information about addresses which are yet to appear! This means that I'll have to keep updating counters during all of our story**). 

## A First Look

Get the stats for all but the first two OWs under attack: address frequencies for each delta value. 

```{r}
query = packets %>% filter(ow >= 770, ow <= 1280) %>% group_by(ow, attack, src_delta) %>% summarize(sources=n_distinct(src)) 
query %>% ggplot(mapping=aes(x=src_delta, y=sources, color=attack)) + geom_line() # + coord_cartesian(xlim=c(0,1500),ylim=c(0,4000))
```



```{r}
query %>% filter(attack==FALSE) %>% ggplot(mapping=aes(x=src_delta, y=sources, color=attack)) + geom_point() 
# + coord_cartesian(xlim=c(0,1500),ylim=c(0,4000))
```

```{r}
query %>% filter(attack==TRUE) %>% ggplot(mapping=aes(x=src_delta, y=sources, color=attack)) + geom_point() 
# + coord_cartesian(xlim=c(0,1500),ylim=c(0,4000))
```

To analyze the behavior of our classifier, it would be interesting to plot a histogram using 16 (2^log2(m-10)) as a bin size.

# First Attack OWs

Let's set an arbitrary threshold and analyze **only the first 30 OWs under attack**.

```{r}

threshold = 16

first = 770 # Attack begins @769, mitigation begins @770.  OW = 2^14 = 16.384 packets. Proportion = 20%. => ~3200 "evil", rest "good". 
last  = 800 

query1 = packets %>% filter(ow>=first, ow<=last)

true_evil = query1 %>% filter(attack==TRUE) %>% tally()
true_good = query1 %>% filter(attack==FALSE) %>% tally()
message("True evil: ", true_evil, " True good: ", true_good, " Total: ", true_evil + true_good)

class_evil = query1 %>% filter(src_delta>=threshold) %>% tally() 
class_good = query1 %>% filter(src_delta< threshold) %>% tally() 
message("Class evil: ", class_evil, " Class good: ", class_good, " Total: ", class_evil + class_good)

error_evil = query1 %>% filter(src_delta< threshold, attack==TRUE)  %>% tally() 
error_good = query1 %>% filter(src_delta>=threshold, attack==FALSE) %>% tally() 

message("Error evil: ", error_evil, " Error good: ", error_good, " Total: ", error_evil + error_good)
message("Error evil: ", round(error_evil/true_evil,4), " Error good: ", round(error_good/true_good,4))


```

With a threshold equal to 16, we divert ~86% of the attack, while keeping ~90% of the good traffic in the original path. 

It would be interesting to observe what happens **over time**, OW after OW. 

```{r}

first = 770 
last  = 800

query2 = packets %>% filter(ow>=first, ow<=last) %>% mutate(diverted=(src_delta>=threshold)) %>% group_by(ow)

# True good and true evil
query2 %>% filter(attack==FALSE) %>% summarize(n=n()) %>% ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("True Good")
query2 %>% filter(attack==TRUE)  %>% summarize(n=n()) %>% ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("True Evil")

# Classified good and evil.
query2 %>% filter(diverted==FALSE) %>% summarize(n=n()) %>% ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("Forwarded")
query2 %>% filter(diverted==TRUE)  %>% summarize(n=n()) %>% ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("Diverted")

# Errors in classification. 
query2 %>% filter(src_delta< threshold, attack==TRUE)  %>% summarize(n=n()) %>% 
  ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("False Negatives")

query2 %>% filter(src_delta>=threshold, attack==FALSE) %>% summarize(n=n()) %>% 
  ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("False Positives")

query2 %>% group_by(ow, attack, diverted) %>% summarize(n=n()) %>% 
  ggplot(mapping=aes(x=ow, y=n, color=attack, shape=diverted)) + 
  geom_point(position="jitter", size=2.0) + 
  coord_cartesian(xlim=c(770,810),ylim=c(0,16384)) + 
  labs(x="Observation Window", y="Packet Count", title ="Classification Results") +
  scale_x_continuous(expand=expand_scale(add=0)) + 
  scale_y_continuous(expand=expand_scale(add=0)) +
  scale_color_manual(values=c("seagreen4", "orangered1")) + 
  theme_classic()

```

**I finally have a graph that lets me see what's going on over time!!!**

# All Attack OWs

Let's see what happens when we move further toward the end:

```{r}

threshold = 1

first = 770 
last = 1280 

query3 = packets %>% filter(ow>=first, ow<=last)

true_evil = query3 %>% filter(attack==TRUE) %>% tally()
true_good = query3 %>% filter(attack==FALSE) %>% tally()
message("True evil: ", true_evil, " True good: ", true_good, " Total: ", true_evil + true_good)

class_evil = query3 %>% filter(src_delta>=threshold) %>% tally() 
class_good = query3 %>% filter(src_delta< threshold) %>% tally() 
message("Class evil: ", class_evil, " Class good: ", class_good, " Total: ", class_evil + class_good)

error_evil = query3 %>% filter(src_delta< threshold, attack==TRUE)  %>% tally() 
error_good = query3 %>% filter(src_delta>=threshold, attack==FALSE) %>% tally() 
message("FNcount: ", error_evil, " FPcount: ", error_good, " Total: ", error_evil + error_good)
message("FNR: ", round(error_evil/true_evil,4), " FPR: ", round(error_good/true_good,4))
```


```{r}

query4 = packets %>% filter(ow>=first, ow<=last) %>% mutate(diverted=(src_delta>=threshold)) %>% group_by(ow)

# True good and true evil
query4 %>% filter(attack==FALSE) %>% summarize(n=n()) %>% ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("True Good")
query4 %>% filter(attack==TRUE)  %>% summarize(n=n()) %>% ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("True Evil")

# Classified good and evil.
query4 %>% filter(diverted==FALSE) %>% summarize(n=n()) %>% ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("Diverted")
query4 %>% filter(diverted==TRUE)  %>% summarize(n=n()) %>% ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("Forwarded")

# Errors in classification. 
query4 %>% filter(src_delta< threshold, attack==TRUE)  %>% summarize(n=n()/101662) %>% 
  ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("False Negatives")

query4 %>% filter(src_delta>=threshold, attack==FALSE) %>% summarize(n=n()/406242) %>% 
  ggplot(mapping=aes(x=ow,y=n)) + geom_point() + ggtitle("False Positives")

query4 %>% group_by(ow, attack, diverted) %>% summarize(n=n()) %>% 
  ggplot(mapping=aes(x=ow, y=n, color=attack, shape=diverted)) + 
  geom_point(position="jitter", size=2.0) + 
  coord_cartesian(xlim=c(770,1300),ylim=c(0,16384)) + 
  labs(x="Observation Window", y="Packet Count", title ="Classification Results") +
  scale_x_continuous(expand=expand_scale(add=0)) + 
  scale_y_continuous(expand=expand_scale(add=0)) +
  scale_color_manual(values=c("seagreen4", "orangered1")) + 
  theme_classic()

```

# Attack vs TCAD

Now it's a good time to try to correlate these findings with TCAD measurements. 

What are our chosen k coefficients? 

Our experiments with **tcad_m_levels.py** show us candidate values for k, as follows: 

Log2(m) | k     | FPR
--------|-------|-----
13      | 4.000 | 1.8%
14      | 4.125 | 1.7%
15      | 4.250 | 1.8%
16      | 4.500 | 1.6%
17      | 4.750 | 1.6%
18      | 3.625 | 0.0%


TCAD measurements can be found in the following files: 

tcad_m_2_14_k_4.125.log
tcad_m_2_16_k_4.500.log
tcad_m_2_18_k_3.625.log

[Source: DDoS Mitigation.ipynb, section Finding TCAD Values]

```{r}

col_names = c("ts",
              "src_ent",
              "src_ewma",
              "src_ewmmd",
              "dst_ent",
              "dst_ewma",
              "dst_ewmmd",
              "alarm")

col_types = "ciddiddl"

tcad_m14 = read_table2("~/p4sec/ddosm-p4/lab/ddos20/tcad_logs/tcad_m_2_14_k_4.125.log",
                       col_names = col_names,
                       col_types = col_types)

tcad_m14 = tcad_m14 %>% tibble::rowid_to_column("ow")

tcad_m14 = tcad_m14 %>% mutate(src_ent   = src_ent/16,
                               dst_ent   = dst_ent/16,
                               src_ewma  = src_ewma/262144,
                               dst_ewma  = dst_ewma/262144,
                               src_ewmmd = src_ewmmd/262144,
                               dst_ewmmd = dst_ewmmd/262144)

k = 4.125
```

## Entropy Overview

```{r}

base_plot = tcad_m14 %>% ggplot(mapping=aes(x=ow))

base_plot + 
  labs(x="OW number", y="Entropy", title="Entropy for each Observation Window") +
  geom_point(mapping=aes(y=src_ent), size=0.25, color="seagreen4") + 
  geom_point(mapping=aes(y=dst_ent), size=0.25, color="steelblue4") +
  geom_line(mapping=aes(y=src_ewma+k*src_ewmmd), color="seagreen4") +
  geom_line(mapping=aes(y=dst_ewma-k*dst_ewmmd), color="steelblue4") +
  theme_classic()

```

## Entropy Under Attack

Alright, we have the graph. Now we need to focus in the attack (OWs 768-1280).

```{r}

base_plot = tcad_m14 %>% filter(ow>=768, ow<=1280) %>% ggplot(mapping=aes(x=ow))

base_plot + 
  labs(x="OW number", y="Entropy", title="Entropy for each Observation Window - Attack Phase") +
  geom_point(mapping=aes(y=src_ent), size=0.25, color="seagreen4") + 
  geom_point(mapping=aes(y=dst_ent), size=0.25, color="steelblue4") +
  geom_line(mapping=aes(y=src_ewma+k*src_ewmmd), color="seagreen4") +
  geom_line(mapping=aes(y=dst_ewma-k*dst_ewmmd), color="steelblue4") +
  theme_classic()

```

Let's copy these data to specific tibbles. 

```{r}

first = 770 
last = 1280

attack_entropy = tcad_m14 %>% filter(ow>=first, ow<=last) %>% mutate(ow=ow-512)

attack_entropy

mitigation_out = packets %>% 
  filter(ow>=first, ow<=last) %>% 
  mutate(diverted=(src_delta>=threshold)) %>% 
  group_by(ow, attack, diverted) %>% 
  summarize(n=n())

mitigation_out



```
## Typical Frequency Deltas

Question: for each OW, what are the typical frequency deltas (current OW - OW#768) for attack packets? 

```{r}

#query = packets %>% 
#  filter(ow>=first, ow<=last, attack==TRUE) %>% 
#  group_by(ow) %>% 
#  summarize(n=n(),q1=quantile(src_delta,0.25),q2=median(src_delta),q3=quantile(src_delta,0.75),iqr=IQR(src_delta))
#

query5 = packets %>% 
  filter(ow>=first, ow<=last) %>% 
  group_by(ow, attack) %>% 
  summarize(n=n(),q1=quantile(src_delta,0.25),q2=median(src_delta),q3=quantile(src_delta,0.75),iqr=IQR(src_delta))

query5

```

Can we graph it? 

```{r}
query5 %>% 
  filter(ow<800, q1>0) %>% 
  ggplot(mapping = aes(x=ow, shape=attack)) +
  geom_point(mapping = aes(y=q1), color="blue4", position="jitter", size=0.25) +
  geom_point(mapping = aes(y=q2), color="yellow4", position="jitter", size=0.25) +
  geom_point(mapping = aes(y=q3), color="orangered4", position="jitter", size=0.25) +
  coord_trans(y="log10")
  
query5 %>% 
  filter(ow>800, q1>0) %>% 
  ggplot(mapping = aes(x=ow, shape=attack)) +
  geom_point(mapping = aes(y=q1), color="blue4", position="jitter", size=0.25) +
  geom_point(mapping = aes(y=q2), color="yellow4", position="jitter", size=0.25) +
  geom_point(mapping = aes(y=q3), color="orangered4", position="jitter", size=0.25) #+
  #coord_trans(y="log10")
```

(Why does only true packets show up in the graph?)

## Points to Ponder

Question: for each OW, how many different attack sources are there? 

How are these deltas related to entropy?

What else can we do?


